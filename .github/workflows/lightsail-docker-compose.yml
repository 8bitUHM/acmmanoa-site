name: Deploy to AWS Lightsail with Docker Compose

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: us-west-2
  LIGHTSAIL_INSTANCE: acmmanoa-lightsail

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Node.js dependencies
      run: |
        cd theme/static_src
        npm install

    - name: Build Tailwind CSS
      run: |
        cd theme/static_src
        npm run build

    - name: Run Django tests
      run: |
        python manage.py test
      env:
        SECRET_KEY: test-secret-key
        DEBUG: True

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Create deployment package
      run: |
        # Use git archive to create a clean deployment package
        git archive --format=tar.gz --output=deployment.tar.gz HEAD

    - name: Setup SSH key
      run: |
        # Create .ssh directory
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Write the SSH key from secrets
        echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail-key
        chmod 600 ~/.ssh/lightsail-key
        
        # Add the key to SSH agent
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/lightsail-key

    - name: Upload to Lightsail instance
      run: |
        # Get the public IP of the Lightsail instance
        INSTANCE_IP=$(aws lightsail get-instance --instance-name $LIGHTSAIL_INSTANCE --query 'instance.publicIpAddress' --output text)
        
        # Upload the deployment package
        scp -o StrictHostKeyChecking=no -i ~/.ssh/lightsail-key deployment.tar.gz ubuntu@$INSTANCE_IP:/home/ubuntu/
        
        # SSH into the instance and deploy
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/lightsail-key ubuntu@$INSTANCE_IP << 'EOF'
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting deployment..."
          
          # Stop existing containers
          echo "ğŸ“¦ Stopping existing containers..."
          docker-compose -f docker-compose.lightsail.yml down || true
          
          # Extract new code
          echo "ğŸ“ Extracting deployment package..."
          tar -xzf deployment.tar.gz
          
          # Create .env file with environment variables
          echo "ğŸ”§ Creating environment file..."
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" > .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}" >> .env
          
          # Show environment file (without sensitive data)
          echo "ğŸ“‹ Environment file created:"
          ls -la .env
          
          # Build and start containers
          echo "ğŸ—ï¸ Building and starting containers..."
          docker-compose -f docker-compose.lightsail.yml up --build -d
          
          # Wait for containers to be healthy
          echo "â³ Waiting for containers to be ready..."
          sleep 30
          
          # Check container status
          echo "ğŸ“Š Container status:"
          docker-compose -f docker-compose.lightsail.yml ps
          
          # Check if any containers failed to start
          FAILED_CONTAINERS=$(docker-compose -f docker-compose.lightsail.yml ps --services --filter "status=exited")
          if [ ! -z "$FAILED_CONTAINERS" ]; then
            echo "âŒ Some containers failed to start: $FAILED_CONTAINERS"
            echo "ğŸ“‹ Container logs:"
            docker-compose -f docker-compose.lightsail.yml logs
            exit 1
          fi
          
          # Check if containers are actually running
          RUNNING_CONTAINERS=$(docker-compose -f docker-compose.lightsail.yml ps --services --filter "status=running")
          if [ -z "$RUNNING_CONTAINERS" ]; then
            echo "âŒ No containers are running!"
            echo "ğŸ“‹ All container status:"
            docker ps -a
            echo "ğŸ“‹ Docker-compose logs:"
            docker-compose -f docker-compose.lightsail.yml logs
            exit 1
          fi
          
          # Run database migrations
          echo "ğŸ—„ï¸ Running database migrations..."
          docker-compose -f docker-compose.lightsail.yml exec -T web python manage.py migrate
          
          # Collect static files
          echo "ğŸ“ Collecting static files..."
          docker-compose -f docker-compose.lightsail.yml exec -T web python manage.py collectstatic --noinput
          
          # Final status check
          echo "âœ… Final container status:"
          docker-compose -f docker-compose.lightsail.yml ps
          
          # Clean up
          rm deployment.tar.gz
          
          echo "ğŸ‰ Deployment completed!"
        EOF

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment to AWS Lightsail successful!"
        else
          echo "âŒ Deployment to AWS Lightsail failed!"
        fi
